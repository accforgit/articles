function project_member_edit_yes(){var e=$("input[name='data[name]']"),t=$("input[name='data[member_id]']").val(),a=/^(?!_)(?![0-9])[\u4e00-\u9fa5_a-zA-Z0-9]+$/,r=e.val();return r=$.trim(r),r.length>0&&!a.test(r)?!1:r.length>12?!1:void $.ajax({type:"POST",url:$("#user-info-form").attr("action"),data:$("#user-info-form").serialize(),dataType:"json",success:function(e){var a=null,i=e.role_ids,s=[];if(1==e.status){if(t==e.member_id){a=$("#member-list-wrap [data-id="+t+"]"),r.length>0?a.find(".user-real-name").text("("+r+")"):a.find(".user-real-name").text("");for(var n=0;n<i.length;n++)"undefined"!=typeof roleMap[i[n]]&&s.push(roleMap[i[n]]);a.find(".user-roles").text(s.join(";")),$.inArray(projectMemberProjectAdminID,i)>-1?a.find(".departure-li").addClass("project-member-hide"):a.attr("data-user-id")!=user_id&&a.find(".departure-li").removeClass("project-member-hide"),TFL.tips.showFlash("修改信息成功！"),setTimeout(function(){TFL.dialog.close(!1,"",!1,"","edit-member")},100)}}else TFL.tips.showFlash(e.msg)},error:function(e){TFL.tips.showFlash(e)}})}function project_member_edit_no(){TFL.dialog.close(!1,"",!1,"","edit-member")}TFL.widget("projectManagement",{isIngDoSearch:!1,init:function(){this.getTemplate()},getTemplate:function(){var e=this,t=is_sso_company||is_qyweixin_company||!has_company_setting_permission?"搜索成员":"搜索成员，或输入邮箱邀请";$("body").append(template("project-member-management-tpl",{tips:t})),$("#cloud-user-management").removeAttr("style"),e.changeDomStyle(),e.bindEvent()},changeDomStyle:function(){var e=document.body.clientHeight,t=0;$(".project-member").css({top:t}),$(".project-member").height(e-t),$("#member-list-wrap").height(e-265),this.memberListWrap=e-265},getList:function(e,t){var a=this;!t&&$("#member-list-wrap .need-refresh").remove(),a.loadingStatus(t,!0);var r=$.trim($(".member-search input").val());r==$(".member-search input").attr("placeholder")&&(r=""),""!=r?$(".add-member-link").hide():$(".add-member-link").show(),"undefined"!=typeof a.ajaxStatus&&a.ajaxStatus.abort(),a.ajaxStatus=$.ajax({type:"POST",url:_base+_workspace_id+"/project_member_management/get_member_list",data:{"data[search_content]":r,"data[page]":e},success:function(e){a.isIngDoSearch=!1,a.loadingStatus(t,!1),a.moreMemberLoading=!1,$("#member-list-wrap").append(e),a.ajaxStatus=void 0},error:function(){if("undefined"==typeof arguments[1]||"abort"!=arguments[1]){a.isIngDoSearch=!1,a.loadingStatus(t,!1);var e=$("#loading-error-tips").clone().removeAttr("id").addClass("loading-error-tips-instance");$(".project-members").length>0?e.insertAfter($(".project-members").last()):$("#member-list-wrap").append(e),e.show(),a.ajaxStatus=void 0}}})},bindEvent:function(){var e=this;$.browser.msie&&TFL.use("placeholder",function(){TFL.placeholder.init(),TFL.placeholder.refresh(".project-member")}),$(window).off("resize.projectMember").bind("resize.projectMember",function(){e.changeDomStyle()}),$("#member-list-wrap").delegate(".project-members li","hover",function(e){var t=e.type;0==$("#member-list-wrap .dropdown-open").length&&("mouseenter"==t?$(this).addClass("hover"):$(this).removeClass("hover"))}).bind("dropdownclose",function(e){$(e.target).parents(".hover").removeClass("hover")}).delegate(".project-members .dropdown-menu li","click",function(){var t=$(this),a=t.attr("type");switch(a){case"edit-member":e.dealEditMember(t);break;case"re-send-email":e.dealReSendEmail(t);break;case"remove-project":e.dealRemoveProject(t);break;case"set-departure":e.dealDeparture(t);break;default:console.log("undefined type!")}}).bind("scroll",function(){if(!currentIsLastPage&&!e.moreMemberLoading){var t=$(this).scrollTop(),a=0;$(".project-members").each(function(){a+=$(this).height()}),a-e.memberListWrap-t<1200&&(e.curPage++,e.moreMemberLoading=!0,e.getList(e.curPage,!0))}}).delegate(".reload-list-btn","click",function(){var t=$(".project-members").length>0?!0:!1;$(".loading-error-tips-instance").remove(),e.getList(e.curPage,t)}),$(".project-member").delegate("#close-tab-icon","click",function(){e.closeMemberTab()}),$("#project-member-mask").bind("click",function(){e.closeMemberTab()}),$(".member-search input").bind({keyup:function(t){13==t.keyCode&&e.doSearch()}}),$(".member-search i").bind("click",function(){e.doSearch()}),$("#member-list-wrap").delegate("#add-to-project","click",function(){var t=$(this);t.hasClass("added-project")||(e.addCompanyMember2Project(t),t.addClass("added-project"))}),$("#member-list-wrap").delegate(".invite-email-link","click",function(){var t=$(this);e.inviteMember2ProjectByEmail(t)})},inviteMember2ProjectByEmail:function(e){var t=this,a=e.attr("invite-email"),r="";$(".invite-user-by-email .j-validate-code").size()>0&&(r=$(".invite-user-by-email .j-validate-code").val()),$.ajax({type:"POST",url:_base+_workspace_id+"/project_member_management/invite_member_2_project",data:{"data[email]":a,"data[secureCode]":r},dataType:"json",success:function(e){TFL.tips.showFlash(e.msg),1==e.status&&($(".member-search input").val(""),t.doSearch()),TFL.tips.showFlash(e.msg)}})},addCompanyMember2Project:function(e){var t=e.attr("user-id");$.ajax({type:"POST",url:_base+_workspace_id+"/project_member_management/add_company_member_2_project",data:{"data[user_id]":t},dataType:"json",success:function(t){1==t.status&&e.html("已加入"),TFL.tips.showFlash(t.msg)}})},doSearch:function(){this.isIngDoSearch||(this.isIngDoSearch=!0,$(".more-loading-instance").remove(),this.getList(1,!1),this.curPage=1)},closeMemberTab:function(){$("body").removeClass("no-scroll"),$(".project-member-mask").hide(),$(".project-member").animate({right:-350})},showMemberTab:function(){$("body").addClass("no-scroll"),this.hasInit||(this.getList(1,!1),this.curPage=1),this.hasInit=!0,$(".project-member-mask").show(),$(".project-member").animate({right:0})},loadingStatus:function(e,t){if(e)if(t){var a=$("#more-loading-template").clone();a.removeAttr("id").addClass("more-loading-instance"),a.insertAfter($(".project-members").last()),a.show()}else $(".more-loading-instance").remove();else t?$("#member-loading").show():$("#member-loading").hide()},dealEditMember:function(e){var t=e.parents(".user-info").attr("data-id");TFL.dialog.show({title:"",url:_base+_workspace_id+"/tcloud/personal_settings/edit_member/"+t+"/quick?width=440&height=570",useIframe:!1,fullscreen:!1,id:"edit-member",dataBtn:"确定:project_member_edit_yes,取消:project_member_edit_no"})},dealReSendEmail:function(e){var t=e.parents(".user-info").attr("data-user-id"),a=e.attr("data-email");return a?void $.ajax({type:"POST",url:_base+_workspace_id+"/settings/resend_active_mail",data:{"data[email]":a,"data[user_id]":t},dataType:"json",success:function(e){var t=e.msg;TFL.tips.showFlash(t)}}):void TFL.tips.showFlash("data error , not find email for user!")},dealRemoveProject:function(e){var t=e.parents(".user-info").attr("data-id"),a=e.parents(".user-info").find(".user-name").text(),r=this;TFL.confirm("是否将“"+a+"”移出项目？",function(){$.ajax({type:"get",url:_base+_workspace_id+"/settings/delete_member/"+t+"/quick",success:function(e){TFL.tips.showFlash(e);var a=$("#member-list-wrap [data-id="+t+"]").parents("li");r.deleteOneLine(a)}})})},dealDeparture:function(e){var t=e.parents(".user-info").attr("data-id"),a=e.parents(".user-info").attr("data-user-id"),r=e.parents(".user-info").find(".user-name").text(),i=this;TFL.confirm("是否将“"+r+"”设为离职？",function(){$.ajax({type:"get",url:_base+_workspace_id+"/project_member_management/set_user_departure/"+a,dataType:"json",success:function(e){if(TFL.tips.showFlash(e.msg),1==e.status){var a=$("#member-list-wrap [data-id="+t+"]").parents("li");i.deleteOneLine(a)}}})})},deleteOneLine:function(e){e.fadeOut(300,function(){e.remove()}),$("#member-count").text($("#member-count").text()-1)}});