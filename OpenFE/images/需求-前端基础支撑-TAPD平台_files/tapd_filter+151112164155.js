TFL.widget("TapdFilter",{objs:{},get_instance:function(e){return this.objs[e]?this.objs[e]:null},get_condition_from_url:function(){var e=$.url(location.href),t=e.param();return this.get_condition_from_data(t)},get_condition_from_data:function(e){var t={};for(var i in e){if(this.isArray(e[i]))for(var n in e[i])e[i][n]=decodeURIComponent(e[i][n]),0==i.indexOf("data[Filter]")&&e[i][n].length>0&&(t[i]=e[i]);else e[i]=decodeURIComponent(e[i]),0==i.indexOf("data[Filter]")&&e[i].length>0&&(t[i]=e[i])}return t},isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},init:function(e,t){return this.objs[e]={filter_form:null,more_condition_panel:null,filter_prefix:"",init:function(e){this.filter_form=e.filter_form||"",this.filter_prefix=e.filter_prefix||"data[BasicSearch]",this.more_condition_panel=this.filter_form.find(".condition-panel"),this.generate_load_more_condition_panel_url()},close:function(){this.more_condition_panel.dialog("close")},dealMoreFields:function(e){for(var t=$([]),i=new Array,n=0;n<e.length;n++){var r=$("<div class='form-item' field-name='"+e[n].name+"'></div>"),o=$("<label class='control-label'>"+e[n].label+"</label>"),a=$("<div class='controls'></div>"),l=this.filter_prefix+"["+e[n].name+"]";switch(e[n].type){case"radio":e[n].obj.find("input").attr("name",l),a.append(e[n].obj);break;case"checkbox":e[n].obj.find("input").attr("name",l+"[]");var c=$("<div class='wrapper-all'></div>");c.append(e[n].obj),a.append(c);break;case"date-between":case"datetime-between":e[n].obj.eq(0).attr({name:l+"[begin]","date-to":l+"[end]"}),e[n].obj.eq(2).attr({name:l+"[end]","date-from":l+"[begin]"}),a.append(e[n].obj);break;case"userchooser":case"mixchooser":case"avatarlist":e[n].obj.eq(0).attr("name",l),a.append(e[n].obj);break;case"tree_select":i.push(e[n].id),e[n].obj.attr("name",l),a.append(e[n].obj);break;case"multi_select":e[n].obj.find(":checkbox").attr("name",l+"[]"),a.append(e[n].obj);break;default:"dkselect"==e[n].type&&-1!==e[n].name.indexOf("custom_field_")?(e[n].obj.find(":checkbox").attr("name",l+"[]"),a.append(e[n].obj)):(e[n].obj.attr("name",l),a.append(e[n].obj))}r.append(o).append(a),t=t.add(r)}this.filter_form.find(".filter_condition_panel").append(t),this.customize_fields(),this.deal_tree_select(i)},generate_load_more_condition_panel_url:function(){var e=this.filter_form.attr("customized_fields_service"),t=this.filter_form.attr("append_url_param"),i=this.filter_form.attr("from"),n=this.filter_form.find("#fields_not_show").val(),r=this.get_fields_from_from(),o=_base+_workspace_pretty_name+"/filters/more_condition_panel/"+e+"/"+r.join(",")+"/"+t;if(""!=n&&(o=o+"/"+n),void 0!=i&&""!=i&&(""!=n?o+=i:o=o+"/,/"+i),this.filter_form.find(".more-filters-toggle").attr("load-url",o),$("#selected_id").size()>0&&""!=$("#selected_id").val()){var a=this;a.filter_form.delegate("#more_condition","click",function(){a.load_more_condition_panel(function(){})})}},customize_fields:function(){var e=this,t=_base+_workspace_pretty_name+"/filters/customize_fields",i={};i["data[customized_fields_service]"]=e.filter_form.attr("customized_fields_service"),i["data[fields_current]"]=e.get_fields_from_from().join(","),$.post(t,i,function(e){})},load_more_condition_panel:function(e){var t=this.filter_form.attr("customized_fields_service"),i=this.get_fields_from_from(),n=this.filter_form.attr("append_url_param");if($("#selected_id").size()>0&&""!=$("#selected_id").val())var r=_base+$("#selected_id").val()+"/filters/more_condition_panel/"+t+"/"+i.join(",")+"/"+n;else var r=_base+_workspace_pretty_name+"/filters/more_condition_panel/"+t+"/"+i.join(",")+"/"+n;this.more_condition_panel.load(r,{},e)},get_fields_from_more_condition_panel:function(){var e=[];return this.more_condition_panel.find("input:checked").each(function(){e.push($(this).val())}),e},get_fields_from_from:function(){var e=[],t=this.filter_form.find(".form-item");return t.each(function(){var t=$(this).attr("field-name");e.push(t)}),e},get_condition_from_form:function(){var e={},t=this.filter_form.find(".filter_condition_panel").serializeArray();return jQuery.each(t,function(t,i){if(""!=i.value)if("[]"==i.name.slice(-2)){var n=i.name.slice(0,-2);void 0==e[n]&&(e[n]=[]),e[n].push(i.value)}else e[i.name]=i.value}),e},deal_tree_select:function(e){if(e.length>0)for(var t=0;t<e.length;t++){var i=e[t],n=$.parseJSON(decodeURIComponent($("#"+i).attr("data-nodes")));TFL.use("TreeChooser,TreeChooserExcheck",function(){TFL.TreeChooser().init("#"+i,{view:{selectedMulti:!0,nameIsHTML:!0,dblClickExpand:!1},check:{enable:!0,chkStyle:"checkbox",autoCheckTrigger:!0,chkboxType:{Y:"s",N:"s"}},callback:{beforeClick:function(e,t){return!1},beforeCheck:function(e,t){var n=$.fn.zTree.getZTreeObj($("#"+i).next().find("ul").attr("id"));t.checked?n.cancelSelectedNode(t,!0):n.selectNode(t,!0,!0)},onCheck:function(e,t,n){for(var r=$.fn.zTree.getZTreeObj($("#"+i).next().find("ul").attr("id")),o=r.getCheckedNodes(!0),a="",l="",c=0;c<o.length;c++){var s=htmlspecialchars_decode(o[c].name),d=o[c].id;a.length?a+=";"+s:a=s,l.length?l+=";"+d:l=d}$(".treechooser-name").val(a),$(".treechooser-name").next().val(l)},onClick:function(e,t,i){}},filter:!0,clickClosePanel:!1,fillCategoryName:!0},n)})}}},this.objs[e].init(t),this.objs[e]}});