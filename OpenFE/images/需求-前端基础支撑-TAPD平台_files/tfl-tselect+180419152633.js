TFL.widget("tselect",{init:function(){$(document).delegate(".select-dropdown","click",TFL.tselect._init)},_init:function(e){var t=e.type?$(this):$(e),n={};if(t.hasClass("dropdown-open")){var a=TFL.tagBoolean("data-multiple",t,!1),i=TFL.tagBoolean("data-searchable",t,!0);n.separator=t.attr("data-separator")||"|",t.data("options",n),a?TFL.tselect._initMultiple(t):TFL.tselect._initSingle(t),i&&TFL.tselect._initSearchable(t,a),t.attr("tselect-init",!0)}},_initMultiple:function(e){var t=e.find(".select-dropdown-panel"),n=e.data("options"),a=n.separator,i="|",o=e.attr("value")?e.attr("value").split(i):[];TFL.tselect._setMultipleChecked(e,o),e.find(".dropdown-menu label.checkbox").click(function(e){e.stopPropagation()});var c=e.find(".dropdown-menu :checkbox");$.browser.msie&&c.click(function(){this.blur(),this.focus()}),c.off("change").on("change",function(){var n=[],o=[];c.each(function(){var e=$(this);this.checked&&(n.push($.trim(e.parent().text())),o.push(e.val()))});var d=n.join(a);if(t.text(d).attr("title",d),"tselect-multiple"==t.closest("td").attr("data-editable")?t.closest("td").attr("title",d):"",e.attr("value",o.join(i)),e.trigger("tselect-change"),"undefined"!=typeof e[0].fakeObj&&0==e.find(".dropdown-menu").length)if(e.find("div.checkboxArea").length>0)e.find("div.checkboxArea").html(e[0].fakeObj.find('[type="checkbox"]').clone(!0));else{var r=$('<div class="checkboxArea" style="width: 0;height: 0;overflow: hidden;"></div>');e[0].fakeObj.find('[type="checkbox"]').clone(!0).appendTo(r),e.append(r)}})},_searchItems:function(e,t){return t?void e.data("tselect-searchItems",e.find(t)):e.data("tselect-searchItems")},_searchSource:function(e,t){return t?void e.data("tselect-searchSource",t):e.data("tselect-searchSource")},_initSearchable:function(e,t){var n;n=e.find(".select-search-wrap").length?e.find(".select-search-wrap"):$('<div class="select-search-wrap"><input type="text" class="select-search"/></div>').prependTo(e.find(".dropdown-menu")),n.prepend('<i class="font font-search"></i>');var a=e.offset(),i=(e.parent(),null);if(e[0].fakeObj?i=e[0].fakeObj:(i=e.clone(!0),e[0].fakeObj=i),n.find("input.select-search").bind("click",function(e){e.stopPropagation()}).bind("keyup",function(e){var t=this,n=t.value;setTimeout(function(){n===t.value&&TFL.tselect._search(i,t)},200)}),i.addClass("dropdown-open").appendTo("body"),i.find(".dropdown-toggle").remove(),1==e.find(".dropdown-menu").length){var o=+new Date+Math.floor(1e5*Math.random());i.attr("data-dropdownId",o),1===i.find(".dropdown-menu").length&&i.find(".dropdown-menu").remove(),e.find(".dropdown-menu").attr("id",o).appendTo(i),i.find(".dropdown-menu").css("width",e.width()).find("ul").addClass("webkit-scrollbar")}var c=5,d=i.find(".dropdown-menu").outerHeight();if(d+a.top+e.height()+c>window.innerHeight&&a.top-d-c>0?(a.top=e.offset().top-c,i.addClass("dropdown-up")):a.top=e.offset().top+e.height(),i.css({position:"absolute",left:a.left,top:a.top,"z-index":1002}),0==e.find(".dropdown-menu").length)if(e.find("div.checkboxArea").length>0)e.find("div.checkboxArea").html(e[0].fakeObj.find('[type="checkbox"]').clone(!0));else{var r=$('<div class="checkboxArea" style="width: 0;height: 0;overflow: hidden;"></div>');e[0].fakeObj.find('[type="checkbox"]').clone(!0).appendTo(r),e.append(r)}t?TFL.tselect._searchItems(i,".dropdown-menu ul label"):TFL.tselect._searchItems(i,".dropdown-menu ul a");var l=[];TFL.tselect._searchItems(i).each(function(){l.push($(this).text())}),TFL.tselect._searchSource(i,l),e.bind("dropdownclose",function(){TFL.tselect._emptySearch(i)}),e.bind("dropdownopen",function(){n.focus()})},_search:function(e,t){var n,a=TFL.tselect._searchItems(e);if(""===$.trim(t.value))a.show();else{a.hide(),n=TFL.tselect._getSearchResult(t.value,TFL.tselect._searchSource(e));for(var i=n.length-1;i>=0;i--)a.eq(n[i]).show()}},_getSearchResult:function(e,t){for(var n=[],e=e.toLowerCase(),a=t.length-1;a>=0;a--)-1!==t[a].toLowerCase().indexOf(e)&&n.push(a);return n},_emptySearch:function(e){e.find(".select-search").val("");var t=$(TFL.tselect._searchItems(e));t.show()},_initSingle:function(e){var t=e.find(".select-dropdown-panel");TFL.tselect._setHiddenInput(e,e.attr("value")),e.find(".dropdown-menu a").each(function(){var n=$(this);n.attr("value")==e.attr("value")&&(TFL.tselect._setSingleChange(e,n),t.text(n.text()).attr("title",n.text())),n.click(function(){var n=$(this),a=n.text();t.text(a).attr("title",a),TFL.tselect._setSingleChange(e,n),e.trigger("tselect-change")})})},_setSingleChange:function(e,t){e.find("a.bold").removeClass("bold"),t.addClass("bold"),e.attr("value",t.attr("value"));var n=e.attr("name");n&&e.find("input[name='"+n+"']").length&&e.find("input[name='"+n+"']").val(t.attr("value"))},_setMultipleChecked:function(e,t){$(t).each(function(t,n){e.find(".dropdown-menu input:checkbox").each(function(){var e=$(this);return e.val()==n?(this.checked||(this.checked=!0),!1):void 0})})},_setHiddenInput:function(e,t){var n=e.attr("name");if(n&&!e.find("input[name='"+n+"']").length){var a=$("<input type='hidden'>");a.attr("name",n).val(t),e.append(a)}},initData:function(e){$(e).each(function(){var e,t=$(this),n=TFL.tagBoolean("data-multiple",t,!1),a="|";n?(e=t.attr("value")?t.attr("value").split(a):[],TFL.tselect._setMultipleChecked(t,e)):(e=t.attr("value"),TFL.tselect._setHiddenInput(t,e))})}},!0);