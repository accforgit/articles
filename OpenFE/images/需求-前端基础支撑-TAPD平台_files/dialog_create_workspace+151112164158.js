TFL.widget("DialogCreateWorkspace",{isCreating:!1,isCreatable:!0,init:function(e){var a=this;TFL.DialogCreateWorkspace.isCreating=!1,e.click(function(){var e=this,i=$(e).attr("bu_id");return $.getJSON(_base+"company/is_creatable/"+i,function(t){t.creatable?a.dialog(e,t.show_all_template):(max_project_num=t.max_project_num?t.max_project_num:null,a.dialogError(i,max_project_num))}),!1})},dialogError:function(e,a){var i;i=-1==a?"你没有参与该公司！":-2==a?"该公司已过期！请续费！":"-1"===e?"你所在公司的项目个数都已达到上限，TAPD还未开放创建更多项目的功能，敬请期待！":"抱歉，公司可创建的项目个数已满"+a+"个，TAPD还未开放创建更多项目的功能，敬请期待！",$("#dialogError").length?$("#dialogError").dialog("open").find(".bd").text(i):$('<div id="dialogError" class="media" style="padding:0 20px 30px;"><div class="img"><i class="ico-big-warning"></i></div><div class="bd" style="line-height: 1.6; padding-top: 4px;">'+i+"</div></div>").appendTo("body").dialog({modal:!0,width:400,minHeight:50,open:function(e){var a=$(this);$(".ui-widget-overlay").one("click",function(){a.dialog("close")})}}).dialog("open")},dialog:function(e,a){var e=$(e),i=e.attr("bu_id"),t=e.attr("dashboard_create");if(void 0==t)var o=_base+"company/create/"+i;else var o=_base+"company/create/"+i+"/yes";var r=$.trim(e.closest(".project-group").find(".header h1").text()),s=r?"在"+r+"下创建项目":"创建项目";TFL.dialog.show({title:s,url:o,useIframe:!1,dataBtn:"确定:TFL.DialogCreateWorkspace.confirm,取消:TFL.DialogCreateWorkspace.cancel",minHeight:400,width:a?715:628,height:"auto",fullscreen:!1,loadingType:2}),TFL.use("validate",function(){$("body").on("focus",":input",function(){TFL.validate.inputMessage.show(this)}).on("blur",":input",function(){"name"==this.id&&(workspace_name=$(this).val(),""==workspace_name||TFL.DialogCreateWorkspace.checkWorkspaceName(workspace_name)?$(this).setCustomValidity(""):$(this).setCustomValidity("项目名称请输入中英文、下划线、英文句号、空格和数字，且只能以中英文开头，不超过30字符"),TFL.validate.checkValidity("#workspace-create-form")),TFL.validate.inputMessage.hide(this)})})},checkWorkspaceName:function(e){return e=$.trim(e),!/^[\u4e00-\u9fa5|a-z]+[\u4e00-\u9fa5|\w|\.|\s]*$/i.test(e)||TFL.DialogCreateWorkspace.get_bytes_length(e)>30?!1:!0},get_bytes_length:function(e){var a=0;for(i=0;i<e.length;i++)iCode=e.charCodeAt(i),a+=iCode>=0&&iCode<=255||iCode>=65377&&iCode<=65439?1:2;return a},confirm:function(){if(TFL.DialogCreateWorkspace.isCreatable=!0,!TFL.DialogCreateWorkspace.isCreating){var e=$("#current-bu-id").val();if($.ajax({type:"GET",url:_base+"company/is_creatable/"+e,async:!1,dataType:"json",success:function(a){a.creatable||(max_project_num=a.max_project_num?a.max_project_num:null,TFL.DialogCreateWorkspace.dialogError(e,max_project_num),TFL.DialogCreateWorkspace.isCreatable=!1)}}),!TFL.DialogCreateWorkspace.isCreatable)return TFL.dialog.close(),!1;if(TFL.DialogCreateWorkspace.isCreating=!0,"yes"==$("#dashboard_create").val()&&!$("#dashboard_creatable").val())return TFL.dialog.close(),TFL.DialogCreateWorkspace.popDisCreatableDiv(),!1;var a=$.trim($(".workspace-info #name").val());$(".workspace-info #name").val(a),TFL.DialogCreateWorkspace.checkWorkspaceName(a)?$("#name").setCustomValidity(""):$("#name").setCustomValidity("项目名称请输入中英文、下划线、英文句号、空格和数字，且只能以中英文开头，不超过30字符");var i=TFL.validate.checkValidity("#workspace-create-form");if(i){var t=$("#workspace-create-form"),o=$("#workspace-create-select").val(),r=t.attr("action"),s=t.find("#ticket").val();$.post(r,t.serializeArray(),function(e){if(-1==e)$("#name").setCustomValidity("项目名称请输入中英文、下划线、英文句号、空格和数字，且只能以中英文开头，不超过30字符"),TFL.validate.checkValidity("#workspace-create-form");else if(-2==e)TFL.tips.showFlash("您注册的公司版本没有此项目模板"),TFL.validate.checkValidity("#workspace-create-form");else if(-3==e)TFL.tips.showFlash("公司项目数已超过上限"),TFL.validate.checkValidity("#workspace-create-form");else if(-4==e)TFL.tips.showFlash("该公司不存在！"),TFL.validate.checkValidity("#workspace-create-form");else if(-5==e)TFL.tips.showFlash("该公司已关闭！"),TFL.validate.checkValidity("#workspace-create-form");else if($("a[name='TFL.DialogCreateWorkspace.confirm']").addClass("disabled"),$("#name").setCustomValidity(""),TFL.validate.checkValidity("#workspace-create-form"),TFL.dialog.close(),TFL.dialog.show({title:"创建项目",url:_base+"company/creating_progress/"+s+"/"+encodeURIComponent(a),useIframe:!1,dataBtn:"关闭:TFL.DialogCreateWorkspace.cancel",fullscreen:!1}),$("#create-running-li").length>0){var i=$("#create-running-li").clone();i.attr("id",""),i.css("display",""),i.attr("ticket",s),$(".project-list[bu_id="+o+"] li:last-child").before(i)}TFL.DialogCreateWorkspace.isCreating=!1})}else TFL.DialogCreateWorkspace.isCreating=!1}},cancel:function(){TFL.dialog.close()},onsubmit:function(){return!1},popDisCreatableDiv:function(){body="#draft-list-content",TFL.use("mask",function(){TFL.mask.init("body",{noloader:!0,color:"#000",opacity:.3,zindex:802,onShow:function(e,a,i,t){var o=$(".disabled-create-tip").clone().attr("id","disabled_create_tip");i.before(o),$("#disabled_create_tip").css({display:"block","z-index":"803"});var r=($(window).height()-$("#disabled_create_tip").height())/2,s=($(window).width()-$("#disabled_create_tip").width())/2;$("#disabled_create_tip").css({position:"absolute",top:r,left:s})}})})}});