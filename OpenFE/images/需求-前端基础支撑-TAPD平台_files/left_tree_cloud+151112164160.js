TFL.widget("leftTree",{init:function(){this.obj={tree:$("#left-tree"),handle:$("#left-tree-handle2"),main:$("#main-content"),container:$("body"),accordionTrigger:$("#myprojects-accordion")},this._initProjectsMaxHeight(),this._bindMenuHandler(),this._bindMoreProjects(),this._bindAccordion(),this._bindLoadMyProjects(),this._bindBottomFixed(),this._bindSetTop(),this.isLeftTreeClose()?TFL.leftTree.triggerEvent("close",!0):TFL.leftTree.triggerEvent("open",!0),TFL.use("tab",function(){TFL.tab({object:"#left-projects-tab"})})},_bindBottomFixed:function(){$(window).height()<=600?$("#left-tree-bottom").removeClass("left-tree-bottom-fixed").addClass("left-tree-bottom-cloud-no-fixed"):$("#left-tree-bottom").addClass("left-tree-bottom-fixed").removeClass("left-tree-bottom-cloud-no-fixed"),$(window).resize(function(){$(window).height()<=600?$("#left-tree-bottom").removeClass("left-tree-bottom-fixed").addClass("left-tree-bottom-cloud-no-fixed"):$("#left-tree-bottom").addClass("left-tree-bottom-fixed").removeClass("left-tree-bottom-cloud-no-fixed")})},_bindMenuHandler:function(){var e=this,t=(TFL.leftTree.obj.tree,TFL.leftTree.obj.handle),o=(TFL.leftTree.obj.main,TFL.leftTree.obj.container);treeWidth=200,t.click(function(){$(this);e.isLeftTreeClose()?($.cookie("left_tree_status","1",{expires:30,path:"/"}),o.removeClass("left-tree-close"),$(document).trigger("leftTreeToOpen"),setTimeout(function(){TFL.leftTree.triggerEvent("open")},300),TFL.leftTree.loadProjects()):($.cookie("left_tree_status","0",{expires:30,path:"/"}),o.addClass("left-tree-close"),$(document).trigger("leftTreeToClose"),setTimeout(function(){TFL.leftTree.triggerEvent("close")},300)),setTimeout(function(){$(window).trigger("resize")},300)})},loadProjects:function(){var e,t,o,s=this;TFL.leftTree.obj.tree,TFL.leftTree.obj.container,$("#myprojects-wrap");e=$("#myprojects-list"),t="company/my_take_part_in_projects_list",e.find(".iamloaded").length||(t+=window._workspace_id?"?project_id="+_workspace_id+"&t="+(new Date).getTime()+"&from=left_tree":"?t="+(new Date).getTime()+"&from=left_tree",o=_base+_workspace_id+"/"+t,e.append('<li class="loading-wrapper"><i class="loading"></i></li>'),$.get(o,function(t){e.html(t),(0!=$(t).find(".noproject").length||10>=$(t).children().length)&&$("#myprojects-list-wrap .show-more").remove(),s.hideMoreProject()})),TFL.leftTree.expendMyProjects(!0)},triggerEvent:function(e,t){var o=window._workspace_id?_base+_workspace_id+"/":_base;o+="workspaces/toggle_nav/enabled+left+side+bar/","close"===e?$(document).trigger("leftTreeClose"):"open"===e&&$(document).trigger("leftTreeOpen")},setMyProjectsStatus:function(){$("#change-myprojects-status").click(function(){TFL.leftTree.loadProjects();var e=window._workspace_id?_base+_workspace_id+"/":_base;return e+="workspaces/toggle_left_tree_workspace_view?time="+(new Date).getTime(),$.get(e),!1})},_bindAccordion:function(){var e=this;this.obj.accordionTrigger.parent().click(function(){return e.isProjectsExpanded()?(e.expendMyProjects(!1),$(this).blur()):(e.expendMyProjects(!0),$(this).blur()),!1})},expendMyProjects:function(e){e||"undefined"==typeof e?(this.obj.accordionTrigger.addClass("expanded").removeClass("collapsed"),$("#myprojects-wrap").find(".myprojects-content").slideDown(),$("#left-projects-tab").fadeIn()):(this.obj.accordionTrigger.addClass("collapsed").removeClass("expanded"),$("#myprojects-wrap").find(".myprojects-content").slideUp(),$("#left-projects-tab").fadeOut())},isLeftTreeClose:function(){return this.obj.container.hasClass("left-tree-close")},isProjectsExpanded:function(){return this.obj.accordionTrigger.hasClass("expanded")},_bindMoreProjects:function(){$("#myprojects-wrap a.show-more").bind("click",function(){$("#myprojects-wrap").removeClass("view-hidemore"),$("#myprojects-list").css("max-height",parseInt($("#myprojects-list").css("max-height"))+$("#myprojects-wrap .show-more").outerHeight())})},hideMoreProject:function(e){var e=parseInt($("#myprojects-wrap > .myprojects-content").css("max-height"));if($("#myprojects-list").outerHeight()<e)return!1;var t=e-$("#myprojects-wrap .show-more").outerHeight();return isNaN(t)?!1:(t>40?t-=t%40:t=40,$("#myprojects-list").css("max-height",t),void(0!=$("#myprojects-list-wrap .show-more").length&&$("#myprojects-wrap").addClass("view-hidemore")))},setMyProjectsMaxHeight:function(){var e=$(".top-alert").length>0?!0:!1,t=e?27:0,o=118+tcube_height+t,s=$("#myprojects-wrap > .myprojects-content"),r=$(window).height()-s.position().top-o;s.css("max-height",r),TFL.leftTree.hideMoreProject(r)},_initProjectsMaxHeight:function(){var e=this;this.setMyProjectsMaxHeight(),$(window).bind("resize",function(){e.setMyProjectsMaxHeight()})},_bindLoadMyProjects:function(){this.isLeftTreeClose()||TFL.leftTree.loadProjects()},_bindSetTop:function(){$("#myprojects-list").delegate(".font-public-star","click",function(){if($(this).hasClass("highlight")){$(this).removeClass("highlight");var e=$("#myprojects-list .highlight").size(),t=$(this).attr("object-id"),o=$(this).closest("li"),s=_base+"0/projects/set_top_workspace/"+t+"/cancel_settop";$.ajax({type:"GET",url:s,success:function(t){t?(TFL.tips.showFlash("取消置顶成功"),e&&$("#myprojects-list").find(".highlight:last").closest("li").after(o)):TFL.tips.showFlash("取消置顶失败")}})}else{var r=$(this).closest("li");$(this).addClass("highlight");var i=$(this).attr("object-id"),s=_base+"0/projects/set_top_workspace/"+i;$.ajax({type:"GET",url:s,success:function(e){e?($("#myprojects-list").prepend(r),TFL.tips.showFlash("置顶成功")):TFL.tips.showFlash("置顶失败")}})}})}},!0);